<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>56th Mechanical Attendance</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --purple: #7c3aed;
      --gray: #f8fafc;
      --light: #ffffff;
      --border: #e2e8f0;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--gray);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      background: var(--light);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      width: 100%;
      max-width: 460px;
    }
    .tab-nav {
      display: flex;
      border-bottom: 2px solid var(--border);
      margin-bottom: 20px;
    }
    .tab-button {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      font-weight: 600;
      color: #64748b;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: all 0.18s;
    }
    .tab-button.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .tab-button:hover:not(.active) {
      background: var(--gray);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    h2 {
      margin: 0 0 8px;
      text-align: center;
      color: #1e293b;
    }
    .user-info-box {
      background: #e0f2fe;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #bae6fd;
      margin-bottom: 24px;
    }
    .user-name {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .user-email {
      font-size: 0.82rem;
      color: #0369a1;
      opacity: 0.85;
    }
    label {
      display: block;
      margin: 16px 0 6px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #475569;
    }
    input, select, textarea {
      width: 100%;
      padding: 11px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 20px 0;
    }
    button {
      padding: 12px;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    button:active {
      transform: scale(0.98);
      opacity: 0.92;
    }
    .btn-present { background: var(--success); grid-column: span 2; }
    .btn-rso     { background: var(--warning); }
    .btn-mc      { background: var(--danger); }
    .btn-rsi     { background: var(--purple); }
    .btn-late    { background: #4b5563; }
    .btn-leave   { background: var(--primary); grid-column: span 2; }
    .btn-register, .btn-confirm {
      background: var(--primary);
      margin-top: 12px;
    }
    .btn-cancel {
      background: #ef4444;
      margin-top: 12px;
    }
    #dynamicForm {
      border-top: 1px solid var(--border);
      margin-top: 20px;
      padding-top: 12px;
      display: none;
    }
    #statusMsg {
      text-align: center;
      margin-top: 16px;
      font-weight: 600;
      min-height: 1.4em;
      color: var(--success);
    }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 360px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .summary-box {
      background: #f1f5f9;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
      text-align: left;
      font-size: 0.92rem;
    }
    .summary-item {
      margin: 6px 0;
    }
    .summary-label {
      font-weight: 600;
      color: #475569;
    }
    .parade-item {
      padding: 8px 12px;
      background: #f8fafc;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid var(--primary);
    }
    .copy-button {
      background: var(--primary);
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }
    .hidden {
      display: none !important;
    }
    .loading {
      opacity: 0.4;
      pointer-events: none;
    }
    .center-box {
      text-align: center;
      padding: 60px 20px 40px;
    }
    .big-icon {
      font-size: 3.2rem;
      margin-bottom: 16px;
    }
    .missing-item {
      padding: 8px 12px;
      background: #fffbeb;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid #f59e0b;
    }
    /* Parade & Missing sections */
    .parade-edit-section, .missing-edit-section {
      margin-top: 15px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .generate-btn {
      background-color: #f59e0b;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }
    .generate-btn:hover { background-color: #d97706; }
    .formatted-parade-state {
      background-color: #f8fafc;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-family: monospace;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-line;
      margin-top: 15px;
      min-height: 300px;
      max-height: 400px;
      overflow-y: auto;
    }
    .login-form {
      margin-top: 20px;
    }
    .login-option {
      display: block;
      margin: 8px 0;
      padding: 10px;
      background: #f1f5f9;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .login-option:hover {
      background: #e0f2fe;
    }
    .divider {
      text-align: center;
      margin: 20px 0;
      color: #94a3b8;
      font-size: 0.85rem;
    }
    .divider::before,
    .divider::after {
      content: '';
      display: inline-block;
      width: 40%;
      height: 1px;
      background: #e2e8f0;
      vertical-align: middle;
      margin: 0 8px;
    }
  </style>
</head>
<body>

<!-- Role Selection / Login Modal -->
<div id="authModal" class="modal-overlay" style="display:flex;">
  <div class="modal-content">
    <h3>Welcome to 56th Mech Attendance</h3>
    <p>Select login method:</p>

    <div class="login-option" onclick="signInWithGoogle()">üîê Sign in with Google</div>
    <div class="login-option" onclick="signInWithEmail()">üìß Sign in with Email</div>
    <div class="login-option" onclick="signInAsAdmin()">üõ°Ô∏è Admin Login</div>

    <div class="divider">or</div>
    <button class="btn-register" onclick="showRegistration()">üìù Register as Trainee</button>
  </div>
</div>

<!-- Main App -->
<div class="container" id="mainApp" style="display:none;">
  <h2>56th Mechanical Attendance</h2>
  <p style="text-align:center; font-size:0.85rem; color:#64748b; margin:0 0 20px;">Made by 56th Mech Tribe 5</p>

  <div class="tab-nav">
    <button class="tab-button active" onclick="switchTab('attendance')">Attendance</button>
    <button class="tab-button" onclick="switchTab('parade')">Parade State</button>
    <button class="tab-button" onclick="switchTab('missing')">Missing Attendance</button>
  </div>

  <!-- Attendance Tab -->
  <div id="attendance-tab" class="tab-content active">
    <div id="loadingState" style="padding:40px 0; text-align:center;">Authenticating...</div>

    <div id="registerState" class="hidden center-box">
      <div class="big-icon">üëã</div>
      <h3>Welcome!</h3>
      <p>Please enter your <strong>Rank & Name</strong></p>
      <input type="text" id="regNameInput" placeholder="e.g. ME1T Jun Han" autocomplete="off">
      <button class="btn-register" onclick="handleRegister()">Complete Registration</button>
    </div>

    <div id="appContent" class="hidden">
      <div class="user-info-box">
        Hello, <span class="user-name" id="displayUserName"></span>
        <div class="user-email" id="displayUserEmail"></div>
      </div>

      <div class="grid">
        <button class="btn-present" onclick="submitStatus('Present')">üìç Present</button>
        <button class="btn-rso" onclick="showForm('RSO')">RSO</button>
        <button class="btn-mc" onclick="showForm('MC')">MC</button>
        <button class="btn-rsi" onclick="showForm('RSI')">RSI</button>
        <button class="btn-late" onclick="showForm('Late')">Late</button>
        <button class="btn-leave" onclick="showForm('Leave')">Leave</button>
      </div>

      <div id="dynamicForm">
        <h3 id="formTitle">Details</h3>
        <div id="formInputs"></div>
        <button style="background:#1e293b; width:100%; margin-top:12px;" onclick="validateAndStage()">Review & Submit</button>
      </div>
    </div>

    <div id="statusMsg"></div>
  </div>

  <!-- Parade State Tab -->
  <div id="parade-tab" class="tab-content">
    <div class="parade-state-container">
      <h3>Current Parade State</h3>
      <div class="parade-edit-section">
        <h4>Generate Parade State</h4>
        <button class="generate-btn" onclick="generateParadeState()">Generate Parade State</button>
        <div style="margin-top:10px;">
          <button class="copy-button" onclick="copyFormattedParadeState()">üìã Copy All</button>
        </div>
      </div>
      <div id="formattedParadeState" class="formatted-parade-state">Click Generate to create parade state</div>
      <p style="margin-top:16px; font-size:0.82rem; color:#64748b; text-align:center;">
        Source: Firestore ‚Ä¢ `attendance_logs`
      </p>
    </div>
  </div>

  <!-- Missing Attendance Tab -->
  <div id="missing-tab" class="tab-content">
    <div class="missing-attendance-container">
      <h3>Current Missing Attendance</h3>
      <div class="missing-edit-section">
        <h4>Generate Missing Attendance</h4>
        <button class="generate-btn" onclick="generateMissingAttendance()">Generate Missing Attendance</button>
        <div style="margin-top:10px;">
          <button class="copy-button" onclick="copyMissingList()">üìã Copy All</button>
        </div>
      </div>
      <div id="formattedMissingAttendance" class="formatted-parade-state">Click Generate to create missing list</div>
      <p style="margin-top:16px; font-size:0.82rem; color:#64748b; text-align:center;">
        Users who haven‚Äôt submitted today
      </p>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
      <h3>Confirm Submission</h3>
      <div class="summary-box" id="summaryContent"></div>
      <button class="btn-confirm" onclick="finalSubmit()">Yes, Submit</button>
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// üîê Firebase Config ‚Äî DO NOT COMMIT THIS TO GITHUB!
// Instead, store in firebase-config.js and gitignore it.
const firebaseConfig = {
  apiKey: "AIzaSyAL42bYjqqw-eHW47Y8c_PwgVysBK7n9oE",
  authDomain: "attendance-idrus.firebaseapp.com",
  projectId: "attendance-idrus",
  storageBucket: "attendance-idrus.firebasestorage.app",
  messagingSenderId: "561467450966",
  appId: "1:561467450966:web:93b2da8ed9e5e4c5233df7",
  measurementId: "G-9TBLYGP4P5"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Admin credentials (hardcoded for demo ‚Äî replace with custom claims in prod)
const ADMIN_EMAIL = "admin@unit.gov.sg";
const ADMIN_PASSWORD = "YourSecureAdminPass123!";

let currentUser = { uid: "", email: "", name: "", role: "trainee" };
let currentStatus = "";
let cachedParadeData = null;
let cachedMissingData = null;

// --- AUTH FLOW ---
function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result => {
    handleAuthSuccess(result.user);
  }).catch(err => alert("Login failed: " + err.message));
}

function signInWithEmail() {
  const email = prompt("Enter your email:");
  const password = prompt("Enter your password:");
  if (!email || !password) return;
  auth.signInWithEmailAndPassword(email, password)
    .then(user => handleAuthSuccess(user))
    .catch(err => {
      if (err.code === "auth/user-not-found") {
        // Auto-register if not found
        const name = prompt("First time? Enter Rank + Name (e.g. ME1T John):");
        if (name) registerUser(name, email);
      } else {
        alert("Login failed: " + err.message);
      }
    });
}

function signInAsAdmin() {
  auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PASSWORD)
    .then(user => {
      currentUser = { uid: user.uid, email: user.email, name: "Admin", role: "admin" };
      initApp();
    })
    .catch(() => alert("Admin login failed. Check credentials."));
}

function showRegistration() {
  const name = prompt("Enter Rank + Name (e.g. ME1T John):");
  if (name) {
    const email = prompt("Enter your email (must match auth):");
    if (email) registerUser(name, email);
  }
}

function registerUser(name, email) {
  auth.createUserWithEmailAndPassword(email, "temp123!") // temp pwd
    .then(user => {
      db.collection("users").doc(user.uid).set({
        name: name.trim(),
        email: email.trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        currentUser = { uid: user.uid, email: email, name: name.trim(), role: "trainee" };
        initApp();
      });
    })
    .catch(err => alert("Registration failed: " + err.message));
}

function handleAuthSuccess(user) {
  db.collection("users").doc(user.uid).get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      currentUser = {
        uid: user.uid,
        email: user.email,
        name: data.name || user.displayName || "Unknown",
        role: data.role || "trainee"
      };
      initApp();
    } else {
      // First-time user
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('registerState').classList.remove('hidden');
      document.getElementById('regEmail').textContent = user.email;
      currentUser.uid = user.uid;
      currentUser.email = user.email;
    }
  });
}

function initApp() {
  document.getElementById('loadingState').classList.add('hidden');
  if (currentUser.role === "admin") {
    document.getElementById('appContent').classList.add('hidden');
    document.getElementById('registerState').classList.add('hidden');
    document.getElementById('displayUserName').textContent = "Admin";
    document.getElementById('displayUserEmail').textContent = currentUser.email;
  } else {
    document.getElementById('appContent').classList.remove('hidden');
    document.getElementById('registerState').classList.add('hidden');
    document.getElementById('displayUserName').textContent = currentUser.name;
    document.getElementById('displayUserEmail').textContent = currentUser.email;
  }
  refreshParadeState();
}

// --- TAB SWITCHING ---
function switchTab(tab) {
  document.querySelectorAll('.tab-content, .tab-button').forEach(el => el.classList.remove('active'));
  document.getElementById(`${tab}-tab`).classList.add('active');
  document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');

  if (tab === 'parade') generateParadeState();
  if (tab === 'missing') generateMissingAttendance();
}

// --- FORM HANDLING ---
function showForm(type) {
  currentStatus = type;
  const container = document.getElementById('formInputs');
  document.getElementById('dynamicForm').style.display = 'block';
  document.getElementById('formTitle').textContent = `${type} Details`;
  container.innerHTML = "";

  if (type === 'RSO') {
    container.innerHTML = `
      <label>Symptoms</label>
      <input id="d1" placeholder="Symptoms" required>
      <label>Location</label>
      <input id="d2" placeholder="e.g. Choa Chu Kang Polyclinic" required>`;
  } else if (type === 'MC') {
    const today = new Date().toISOString().split('T')[0];
    container.innerHTML = `
      <label>Start Date (dd/mm/yyyy)</label>
      <input type="date" id="d1" min="${today}" required>
      <label>End Date (dd/mm/yyyy)</label>
      <input type="date" id="d2" min="${today}" required>`;
    setTimeout(() => {
      const d1 = document.getElementById('d1');
      const d2 = document.getElementById('d2');
      if (d1 && d2) {
        d1.addEventListener('change', () => {
          d2.min = d1.value || today;
          if (d2.value && d2.value < d1.value) d2.value = d1.value;
        });
        d2.addEventListener('change', () => {
          if (d1.value && d2.value && d2.value < d1.value) d2.value = d1.value;
        });
      }
    }, 0);
  } else if (type === 'RSI') {
    container.innerHTML = `<input id="d1" placeholder="Symptoms" required>`;
  } else if (type === 'Late') {
    container.innerHTML = `
      <label>Reason</label>
      <input id="d1" placeholder="Reason" required>
      <label>Estimated Arrival</label>
      <input type="time" id="d2" required>`;
  } else if (type === 'Leave') {
    container.innerHTML = `
      <select id="d1" required>
        <option value="">-- Select --</option>
        <option>Full-Day</option>
        <option>Half-Day (AM)</option>
        <option>Half-Day (PM)</option>
      </select>`;
  }
}

function validateAndStage() {
  const d1 = document.getElementById('d1');
  const d2 = document.getElementById('d2');
  if (d1 && !d1.value.trim()) { alert("Please fill in required field"); d1.focus(); return; }
  if (d2 && !d2.value.trim()) { alert("Please fill in required field"); d2.focus(); return; }

  let details = d1 ? d1.value.trim() : "";
  let locationOrTime = d2 ? d2.value.trim() : "N/A";

  // Format MC dates if needed
  if (currentStatus === 'MC' && d1.type === 'date') {
    const [y1, m1, d1v] = d1.value.split('-');
    const [y2, m2, d2v] = d2.value.split('-');
    details = `${d1v}${m1}${y1.slice(2)}-${d2v}${m2}${y2.slice(2)}`;
    locationOrTime = "N/A"; // override
  }

  openConfirmation({
    name: currentUser.name,
    status: currentStatus,
    details,
    locationOrTime,
    uid: currentUser.uid,
    email: currentUser.email
  });
}

function openConfirmation(data) {
  const modal = document.getElementById('confirmModal');
  modal.dataset.payload = JSON.stringify(data);
  document.getElementById('summaryContent').innerHTML = `
    <div class="summary-item"><span class="summary-label">Name:</span> ${data.name}</div>
    <div class="summary-item"><span class="summary-label">Status:</span> ${data.status}</div>
    <div class="summary-item"><span class="summary-label">Details:</span> ${data.details || '-'}</div>
    <div class="summary-item"><span class="summary-label">Info:</span> ${data.locationOrTime}</div>
  `;
  modal.style.display = 'flex';
}

function finalSubmit() {
  const modal = document.getElementById('confirmModal');
  const payload = JSON.parse(modal.dataset.payload);
  closeModal();

  const now = new Date();
  const todayStr = `${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()}`;
  const timeStr = `${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;

  const logData = {
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    date: todayStr,
    time: timeStr,
    name: payload.name,
    status: payload.status,
    details: payload.details,
    info: payload.locationOrTime,
    uid: payload.uid,
    email: payload.email
  };

  db.collection("attendance_logs").add(logData)
    .then(() => {
      alert("Submitted successfully ‚úì");
      document.getElementById('dynamicForm').style.display = 'none';
      refreshParadeState();
      generateMissingAttendance();
    })
    .catch(err => alert("Submission failed: " + err.message));
}

function closeModal() {
  document.getElementById('confirmModal').style.display = 'none';
}

// --- PARADE STATE LOGIC ---
function generateParadeState() {
  const btn = document.querySelector('.generate-btn');
  const originalText = btn.textContent;
  btn.textContent = 'Generating...';
  btn.disabled = true;

  const today = new Date();
  const todayStr = `${today.getDate().toString().padStart(2,'0')}/${(today.getMonth()+1).toString().padStart(2,'0')}/${today.getFullYear()}`;
  const timeStr = `${today.getHours().toString().padStart(2,'0')}${today.getMinutes().toString().padStart(2,'0')}`;

  db.collection("settings").doc("course").get()
    .then(doc => {
      const course = doc.exists ? doc.data().name || "56th Mechanical Course" : "56th Mechanical Course";

      // Get latest submission per user (today only)
      return db.collection("attendance_logs")
        .where("date", "==", todayStr)
        .orderBy("timestamp", "desc")
        .get();
    })
    .then(snapshot => {
      const logs = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        // Only keep latest per user
        if (!logs.some(l => l.uid === data.uid)) logs.push(data);
      });

      // Count categories
      const counts = {
        MA: 0, RSI: 0, RSO: 0, 'MC(Ag-)': 0, 'MC(Ag+)': 0,
        HL: 0, OIL: 0, LEAVE: 0, OTH: 0, LATE: 0
      };
      const details = {
        'RSI': [], 'RSO': [], 'MC(Ag-)': [], 'LEAVE': [], 'LATE': []
      };

      logs.forEach(log => {
        const { status, name, details: det } = log;
        if (status === 'Present') counts['MA']++;
        else if (status === 'RSI') {
          counts['RSI']++;
          details['RSI'].push(`${name} (${det})`);
        } else if (status === 'RSO') {
          counts['RSO']++;
          details['RSO'].push(`${name} (${det})`);
        } else if (status === 'MC') {
          // Assume Ag- unless marked Ag+
          const cat = det.includes('+') ? 'MC(Ag+)' : 'MC(Ag-)';
          counts[cat]++;
          details[cat].push(`${name} (${det})`);
        } else if (status === 'Late') {
          counts['LATE']++;
          details['LATE'].push(`${name} (${det})`);
        } else if (status === 'Leave') {
          counts['LEAVE']++;
          details['LEAVE'].push(`${name} (${det})`);
        }
      });

      const totalStrength = logs.length; // or fetch from settings/users count
      const presentCount = counts['MA'];

      let parade = `Parade state at ${timeStr} (${todayStr})\nCourse: ${course}\nTotal Strength: ${totalStrength}\n`;
      parade += `MA: ${counts['MA']}\nRSI: ${counts['RSI']}`;
      if (details['RSI'].length) details['RSI'].forEach(d => parade += `\n${d}`);
      parade += `\nRSO: ${counts['RSO']}`;
      if (details['RSO'].length) details['RSO'].forEach(d => parade += `\n${d}`);
      parade += `\nMC(Ag-): ${counts['MC(Ag-)']}`;
      if (details['MC(Ag-)'].length) details['MC(Ag-)'].forEach(d => parade += `\n${d}`);
      parade += `\nMC(Ag+): ${counts['MC(Ag+)']}`;
      parade += `\nHL: ${counts['HL']}\nOIL: ${counts['OIL']}\nLEAVE: ${counts['LEAVE']}`;
      if (details['LEAVE'].length) details['LEAVE'].forEach(d => parade += `\n${d}`);
      parade += `\nOTH: ${counts['OTH']}\nLATE: ${counts['LATE']}`;
      if (details['LATE'].length) details['LATE'].forEach(d => parade += `\n${d}`);
      parade += `\nPresent Strength: ${presentCount}`;

      document.getElementById('formattedParadeState').textContent = parade;
      btn.textContent = '‚úÖ Generated!';
      setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
    })
    .catch(err => {
      console.error(err);
      document.getElementById('formattedParadeState').textContent = "Error generating parade state.";
      btn.textContent = 'Error!';
      setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
    });
}

// --- MISSING ATTENDANCE ---
function generateMissingAttendance() {
  const btn = document.querySelector('.generate-btn');
  const originalText = btn.textContent;
  btn.textContent = 'Generating...';
  btn.disabled = true;

  const today = new Date();
  const todayStr = `${today.getDate().toString().padStart(2,'0')}/${(today.getMonth()+1).toString().padStart(2,'0')}/${today.getFullYear()}`;

  db.collection("users").get()
    .then(userSnap => {
      const allUsers = userSnap.docs.map(d => ({ uid: d.id, name: d.data().name }));
      return db.collection("attendance_logs")
        .where("date", "==", todayStr)
        .get()
        .then(logSnap => {
          const presentUids = new Set(logSnap.docs.map(d => d.data().uid));
          const missing = allUsers.filter(u => !presentUids.has(u.uid)).map(u => u.name);
          const text = missing.length > 0 ? missing.join('\n') : "All personnel have submitted attendance!";
          document.getElementById('formattedMissingAttendance').textContent = text;
          btn.textContent = '‚úÖ Generated!';
          setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
        });
    })
    .catch(err => {
      document.getElementById('formattedMissingAttendance').textContent = "Error loading missing list.";
      btn.textContent = 'Error!';
      setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
    });
}

// --- UTILS ---
function copyFormattedParadeState() {
  const text = document.getElementById('formattedParadeState').textContent;
  navigator.clipboard.writeText(text)
    .then(() => {
      const btn = event.target;
      const orig = btn.textContent;
      btn.textContent = '‚úÖ Copied!';
      setTimeout(() => btn.textContent = orig, 2000);
    });
}

function copyMissingList() {
  const text = document.getElementById('formattedMissingAttendance').textContent;
  navigator.clipboard.writeText(text)
    .then(() => {
      const btn = event.target;
      const orig = btn.textContent;
      btn.textContent = '‚úÖ Copied!';
      setTimeout(() => btn.textContent = orig, 2000);
    });
}

function submitStatus(status) {
  currentStatus = status;
  openConfirmation({
    name: currentUser.name,
    status,
    details: status === 'Present' ? "At Unit" : "",
    locationOrTime: "N/A",
    uid: currentUser.uid,
    email: currentUser.email
  });
}

// On load: show auth modal
window.onload = () => {
  // If already logged in, skip modal
  auth.onAuthStateChanged(user => {
    if (user) {
      handleAuthSuccess(user);
    } else {
      document.getElementById('authModal').style.display = 'flex';
    }
  });
};
</script>
</body>
</html>
