<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>56th Mech Attendance</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
<style>
:root {
/* Updated color palette for better aesthetics */
--primary: #1e40af; /* Deeper blue */
--primary-light: #3b82f6; /* Lighter blue for accents */
--success: #16a34a; /* Vibrant green */
--warning: #ea580c; /* Warm orange */
--danger: #dc2626; /* Strong red */
--purple: #7e22ce; /* Rich purple */
--light: #f8fafc; /* Soft background */
--gray-50: #f9fafb; /* Slightly warmer light gray */
--gray-100: #f3f4f6; /* Lighter gray */
--gray-200: #e5e7eb; /* Border color */
--gray-800: #1f2937; /* Dark text */
--gray-900: #111827; /* Darkest text */
--white: #ffffff; /* Pure white */
--border-radius: 12px; /* Softer corners */
--shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
--shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
--transition: all 0.2s ease; /* Smooth transitions */
}
* {
box-sizing: border-box;
margin: 0;
padding: 0;
}
body {
font-family: 'Inter', sans-serif;
background: linear-gradient(135deg, var(--gray-50), var(--light)); /* Subtle gradient background */
color: var(--gray-900);
line-height: 1.6;
padding: 16px;
min-height: 100vh;
}
.container {
max-width: 500px;
margin: 0 auto;
background: var(--white);
border-radius: var(--border-radius);
box-shadow: var(--shadow-lg);
overflow: hidden;
}
header {
background: linear-gradient(to right, var(--primary), var(--primary-light)); /* Gradient header */
color: var(--white);
padding: 20px;
text-align: center;
position: relative;
}
.logout-btn {
position: absolute;
top: 12px;
right: 16px;
background: rgba(255,255,255,0.2);
border: none;
color: var(--white);
padding: 6px 12px;
border-radius: 4px;
cursor: pointer;
font-size: 0.9rem;
transition: var(--transition);
}
.logout-btn:hover {
background: rgba(255,255,255,0.3);
}
.screen {
display: none;
padding: 24px;
}
.screen.active {
display: block;
}
.btn {
display: block;
width: 100%;
padding: 14px;
border: none;
border-radius: 8px; /* Softer button corners */
font-weight: 600;
font-size: 1rem;
cursor: pointer;
transition: var(--transition); /* Smooth hover transition */
margin-bottom: 12px;
box-shadow: var(--shadow-sm); /* Subtle button shadow */
}
.btn:hover {
transform: translateY(-2px); /* Lift effect on hover */
box-shadow: var(--shadow-md); /* Enhanced shadow on hover */
}
.btn:active {
transform: translateY(0); /* Reset lift on click */
}
.btn-google {
background: var(--white);
color: var(--gray-900);
border: 1px solid var(--gray-200);
display: flex; /* Align icon and text */
align-items: center;
justify-content: center;
}
.btn-google img {
width: 20px; /* Size Google icon */
height: 20px;
margin-right: 8px; /* Space between icon and text */
}
.btn-email {
background: var(--gray-100);
color: var(--gray-800);
}
.btn-admin {
background: #4b5563;
color: var(--white);
}
.btn-primary {
background: var(--primary);
color: var(--white);
}
.btn-success {
background: var(--success);
color: var(--white);
}
.btn-warning {
background: var(--warning);
color: var(--white);
}
.btn-danger {
background: var(--danger);
color: var(--white);
}
.btn-purple {
background: var(--purple);
color: var(--white);
}
.btn-gray {
background: var(--gray-100);
color: var(--gray-800);
}
.form-group {
margin-bottom: 16px;
}
label {
display: block;
margin-bottom: 6px;
font-weight: 500;
font-size: 0.95rem;
color: var(--gray-800);
}
input, select {
width: 100%;
padding: 12px;
border: 1px solid var(--gray-200);
border-radius: 8px; /* Softer input corners */
font-size: 1rem;
transition: var(--transition);
background-color: var(--gray-50); /* Lighter input background */
}
input:focus, select:focus {
outline: none;
border-color: var(--primary-light); /* Highlight on focus */
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Focus ring */
}
.grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 12px;
margin-top: 16px;
}
.tab-nav {
display: flex;
border-bottom: 1px solid var(--gray-200);
margin-bottom: 24px;
background-color: var(--gray-50); /* Subtle background for tab bar */
}
.tab-btn {
flex: 1;
padding: 12px;
background: none;
border: none;
font-weight: 600;
color: var(--gray-600); /* Muted color for inactive tabs */
cursor: pointer;
text-align: center;
transition: var(--transition);
position: relative;
}
.tab-btn.active {
color: var(--primary);
}
.tab-btn.active::after {
content: '';
position: absolute;
bottom: -1px;
left: 0;
right: 0;
height: 3px;
background-color: var(--primary);
border-radius: 3px 3px 0 0;
}
.user-card {
background: linear-gradient(to bottom right, #dbeafe, #bfdbfe); /* Subtle gradient */
padding: 16px;
border-radius: 8px;
text-align: center;
margin-bottom: 24px;
border: 1px solid #93c5fd; /* Matching border */
box-shadow: var(--shadow-sm); /* Subtle shadow */
}
.toast {
position: fixed;
bottom: 20px;
left: 50%;
transform: translateX(-50%);
background: var(--gray-900);
color: var(--white);
padding: 12px 24px;
border-radius: 8px;
font-weight: 500;
z-index: 1000;
opacity: 0;
transition: opacity 0.3s;
box-shadow: var(--shadow-lg);
}
.toast.show {
opacity: 1;
}
.parade-output {
background: var(--gray-100); /* Lighter background */
padding: 16px;
border-radius: 8px;
font-family: monospace;
white-space: pre-wrap;
font-size: 0.9rem;
max-height: 300px;
overflow-y: auto;
margin-top: 16px;
border: 1px solid var(--gray-200); /* Subtle border */
box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); /* Inner shadow */
}
.divider {
text-align: center;
margin: 20px 0;
color: #9ca3af; /* Muted divider color */
position: relative;
font-size: 0.9rem;
}
.divider::before,
.divider::after {
content: '';
position: absolute;
top: 50%;
width: 40%;
height: 1px;
background: var(--gray-200);
}
.divider::before {
left: 0;
}
.divider::after {
right: 0;
}
.loading-spinner {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid rgba(255,255,255,.3);
border-radius: 50%;
border-top-color: white;
animation: spin 1s ease-in-out infinite;
margin-right: 8px;
}
@keyframes spin {
to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div class="container">
<!-- Login Screen -->
<div id="loginScreen" class="screen active">
<header><h1>56th Mech Attendance</h1></header>
<div style="padding: 24px;">
<h2 style="text-align:center; margin-bottom:24px;">Sign in to log your attendance</h2>
<!-- Standard Email/Password Login -->
<div class="form-group">
<label for="emailInputLogin">Email</label>
<input type="email" id="emailInputLogin" placeholder="you@example.com">
</div>
<div class="form-group">
<label for="passwordInputLogin">Password</label>
<input type="password" id="passwordInputLogin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<button class="btn btn-primary" id="btn-signin-email" onclick="handleEmailLoginFromLoginScreen()">Sign In</button>
<!-- Divider -->
<div class="divider" style="margin: 24px 0;">or</div>
<!-- Google Sign-In -->
<button class="btn btn-google" onclick="signInWithGoogle()">
<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23FFC107' d='M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z'/%3E%3Cpath fill='%23FF3D00' d='M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z'/%3E%3Cpath fill='%234CAF50' d='M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z'/%3E%3Cpath fill='%231976D2' d='M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z'/%3E%3C/svg%3E" alt="Google Logo">
Sign in with Google
</button>
<!-- Instructor Login Button -->
<button class="btn btn-admin" onclick="signInAsAdmin()" style="margin-top: 12px;">üõ°Ô∏è Sign in as Instructor</button>
</div>
</div>
<!-- Email Login (if needed elsewhere) -->
<div id="emailLoginScreen" class="screen">
<header><h1>Email Login</h1></header>
<div style="padding: 24px;">
<div class="form-group">
<label for="emailInput">Email</label>
<input type="email" id="emailInput" placeholder="you@example.com">
</div>
<div class="form-group">
<label for="passwordInput">Password</label>
<input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<button class="btn btn-primary" onclick="handleEmailLogin()">Sign In</button>
<button class="btn btn-gray" onclick="goBackToLogin()">‚Üê Back</button>
</div>
</div>
<!-- Registration (First Time) -->
<div id="registerScreen" class="screen">
<header><h1>Welcome!</h1></header>
<div style="padding: 24px;">
<p style="text-align:center; margin-bottom:24px;">Enter your rank and name</p>
<div class="form-group">
<label for="regName">Rank & Name (e.g. ME1T John)</label>
<input type="text" id="regName" placeholder="ME1T John" maxlength="50">
</div>
<button class="btn btn-primary" onclick="completeRegistration()">Complete Setup</button>
</div>
</div>
<!-- Main App -->
<div id="appScreen" class="screen">
<header>
<h1>56th Mech Attendance</h1>
<button class="logout-btn" onclick="signOut()">Logout</button>
</header>
<div class="tab-nav">
<button class="tab-btn active" onclick="switchTab('attendance')">Attendance</button>
<button class="tab-btn" onclick="switchTab('parade')">Parade</button>
<button class="tab-btn" onclick="switchTab('missing')">Missing</button>
</div>
<!-- Attendance -->
<div id="attendanceTab" class="tab-content">
<div class="user-card">
Hello, <strong id="userNameDisplay"></strong><br>
<small id="userEmailDisplay"></small>
</div>
<div class="grid">
<button class="btn btn-success" onclick="submitStatus('Present')">‚úÖ Present</button>
<button class="btn btn-warning" onclick="openForm('RSO')">RSO</button>
<button class="btn btn-danger" onclick="openForm('MC')">MC</button>
<button class="btn btn-purple" onclick="openForm('RSI')">RSI</button>
<button class="btn btn-gray" onclick="openForm('Late')">Late</button>
<button class="btn btn-primary" onclick="openForm('Leave')">Leave</button>
<!-- Added buttons for HL, OIL, OTH -->
<button class="btn btn-gray" onclick="openForm('HL')">HL</button>
<button class="btn btn-gray" onclick="openForm('OIL')">OIL</button>
<button class="btn btn-gray" onclick="openForm('OTH')">OTH</button>
</div>
<div id="dynamicForm" style="display:none; margin-top:20px;">
<h3 id="formTitle"></h3>
<div id="formFields"></div>
<button class="btn btn-primary" style="margin-top:12px;" onclick="reviewSubmission()">Review & Submit</button>
<button class="btn btn-gray" style="margin-top:8px;" onclick="cancelForm()">Cancel</button>
</div>
</div>
<!-- Parade -->
<div id="paradeTab" class="tab-content" style="display:none;">
<button class="btn btn-primary" onclick="generateParadeState()">
<span id="paradeBtnText">üîÑ Generate Parade State</span>
</button>
<button class="btn btn-gray" style="margin-top:8px;" onclick="copyParadeState()">üìã Copy All</button>
<div class="parade-output" id="paradeOutput">Click "Generate"</div>
</div>
<!-- Missing -->
<div id="missingTab" class="tab-content" style="display:none;">
<button class="btn btn-primary" onclick="generateMissingList()">
<span id="missingBtnText">üîÑ Generate Missing List</span>
</button>
<button class="btn btn-gray" style="margin-top:8px;" onclick="copyMissingList()">üìã Copy All</button>
<div class="parade-output" id="missingOutput">Click "Generate"</div>
</div>
</div>
</div>
<div id="toast" class="toast"></div>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script>
// üîê REPLACE WITH YOUR FIREBASE CONFIG (DO NOT COMMIT TO GITHUB)
const firebaseConfig = {
apiKey: "AIzaSyAL42bYjqqw-eHW47Y8c_PwgVysBK7n9oE",
authDomain: "attendance-idrus.firebaseapp.com",
projectId: "attendance-idrus",
storageBucket: "attendance-idrus.firebasestorage.app",
messagingSenderId: "561467450966",
appId: "1:561467450966:web:93b2da8ed9e5e4c5233df7",
measurementId: "G-9TBLYGP4P5"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
// Admin credentials (for demo only ‚Äî use custom claims in prod)
const ADMIN_EMAIL = "admin@unit.gov.sg";
const ADMIN_PASSWORD = "YourSecureAdminPass123!";
let currentUser = null;
// --- UI Helpers ---
function showToast(msg, isError = false) {
const t = document.getElementById('toast');
t.textContent = msg;
t.style.backgroundColor = isError ? '#ef4444' : '#1e293b';
t.classList.add('show');
setTimeout(() => t.classList.remove('show'), 3000);
}
function showScreen(id) {
document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
document.getElementById(id).classList.add('active');
}
function switchTab(tab) {
['attendance','parade','missing'].forEach(t => {
document.getElementById(`${t}Tab`).style.display = 'none';
document.querySelector(`[onclick="switchTab('${t}')"]`).classList.remove('active');
});
document.getElementById(`${tab}Tab`).style.display = 'block';
document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
// Auto-generate data when switching to parade/missing tabs
if (tab === 'parade') {
generateParadeState();
} else if (tab === 'missing') {
generateMissingList();
}
}
// --- Auth ---
function signInWithGoogle() {
const provider = new firebase.auth.GoogleAuthProvider();
auth.signInWithPopup(provider)
.then(result => handleAuthSuccess(result.user))
.catch(err => {
console.error("Google sign-in error:", err);
showToast("Google login failed: " + err.message, true);
});
}
function showEmailLogin() {
showScreen('emailLoginScreen');
}
function goBackToLogin() {
showScreen('loginScreen');
}
function handleEmailLoginFromLoginScreen() {
// Get credentials from the login screen fields
const email = document.getElementById('emailInputLogin').value.trim();
const pwd = document.getElementById('passwordInputLogin').value;
if (!email || !pwd) return showToast("Fill both fields", true);
auth.signInWithEmailAndPassword(email, pwd)
.then(user => handleAuthSuccess(user.user))
.catch(err => {
if (err.code === "auth/user-not-found") {
const name = prompt("First time? Enter Rank + Name:");
if (name) registerNewUser(name, email, pwd);
} else {
showToast("Login failed: " + err.message, true);
}
});
}
function handleEmailLogin() {
const email = document.getElementById('emailInput').value.trim();
const pwd = document.getElementById('passwordInput').value;
if (!email || !pwd) return showToast("Fill both fields", true);
auth.signInWithEmailAndPassword(email, pwd)
.then(user => handleAuthSuccess(user.user))
.catch(err => {
if (err.code === "auth/user-not-found") {
const name = prompt("First time? Enter Rank + Name:");
if (name) registerNewUser(name, email, pwd);
} else {
showToast("Login failed: " + err.message, true);
}
});
}
function signInAsAdmin() {
auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PASSWORD)
.then(() => {
currentUser = {
uid: auth.currentUser.uid,
email: ADMIN_EMAIL,
name: "Admin",
role: "admin"
};
initApp();
})
.catch(() => showToast("Admin login failed", true));
}
function handleAuthSuccess(user) {
db.collection("users").doc(user.uid).get().then(doc => {
if (doc.exists) {
const data = doc.data();
currentUser = {
uid: user.uid,
email: user.email,
name: data.name,
role: "trainee"
};
initApp();
} else {
currentUser = { uid: user.uid, email: user.email };
showScreen('registerScreen');
}
}).catch(err => {
console.error("Error fetching user ", err);
showToast("Failed to load user data", true);
});
}
function completeRegistration() {
const name = document.getElementById('regName').value.trim();
if (!name) return showToast("Enter rank + name", true);
db.collection("users").doc(currentUser.uid).set({
name: name,
email: currentUser.email,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
}).then(() => {
currentUser.name = name;
initApp();
}).catch(err => {
console.error("Registration error:", err);
showToast("Setup failed: " + err.message, true);
});
}
function registerNewUser(name, email, password) {
auth.createUserWithEmailAndPassword(email, password)
.then(user => {
db.collection("users").doc(user.user.uid).set({
name: name,
email: email,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
}).then(() => {
currentUser = { uid: user.user.uid, email, name, role: "trainee" };
initApp();
});
})
.catch(err => {
console.error("Registration error:", err);
showToast("Registration failed: " + err.message, true);
});
}
// --- App Init ---
function initApp() {
document.getElementById('userNameDisplay').textContent = currentUser.name;
document.getElementById('userEmailDisplay').textContent = currentUser.email;
showScreen('appScreen');
}
// --- Logout ---
function signOut() {
auth.signOut()
.then(() => {
currentUser = null;
showScreen('loginScreen');
showToast("You've been logged out");
})
.catch(err => {
console.error("Logout error:", err);
showToast("Logout failed", true);
});
}
// --- Attendance Submission (NO GEOLOCATION) ---
function submitStatus(status) {
if (status === "Present") {
logAttendance({ status: "Present", details: "At Unit", info: "N/A" });
} else {
openForm(status);
}
}
function openForm(status) {
currentStatus = status;
const title = document.getElementById('formTitle');
const fields = document.getElementById('formFields');
title.textContent = `${status} Details`;
let html = "";
if (status === 'RSO') {
html = `<div class="form-group"><label>Symptoms</label><input id="d1" placeholder="Fever, headache"></div>
<div class="form-group"><label>Location</label><input id="d2" placeholder="Choa Chu Kang Polyclinic"></div>`;
} else if (['MC', 'HL', 'OIL'].includes(status)) { // Handle date ranges for MC, HL, OIL
html = `<div class="form-group"><label>Start Date</label><input type="date" id="d1"></div>
<div class="form-group"><label>End Date</label><input type="date" id="d2"></div>`;
} else if (status === 'RSI') {
html = `<div class="form-group"><label>Symptoms</label><input id="d1" placeholder="Describe symptoms"></div>`;
} else if (status === 'Late') {
html = `<div class="form-group"><label>Reason</label><input id="d1" placeholder="Traffic jam"></div>
<div class="form-group"><label>ETA (HH:MM)</label><input type="time" id="d2"></div>`; // Updated label for Late
} else if (status === 'Leave') {
html = `<div class="form-group"><label>Type</label>
<select id="d1"><option value="">-- Select --</option><option>Full-Day</option><option>Half-Day (AM)</option><option>Half-Day (PM)</option></select></div>`;
} else if (status === 'OTH') {
html = `<div class="form-group"><label>Specify</label><input id="d1" placeholder="e.g. Compassionate Leave, Marriage"></div>`;
}
fields.innerHTML = html;
document.getElementById('dynamicForm').style.display = 'block';
}
function cancelForm() {
document.getElementById('dynamicForm').style.display = 'none';
}
function reviewSubmission() {
const d1 = document.getElementById('d1')?.value?.trim() || "";
const d2 = document.getElementById('d2')?.value?.trim() || "N/A";
if (!d1 && ['RSO','RSI','Late','Leave', 'OTH'].includes(currentStatus)) {
return showToast("Please fill required field", true);
}
if (currentStatus === 'Late' && !d2) { // Specifically check for ETA in Late
return showToast("Please fill the ETA field", true);
}
if (['MC', 'HL', 'OIL'].includes(currentStatus) && (!d1 || !d2)) {
return showToast(`Both start and end dates are required for ${currentStatus}`, true);
}
if (['MC', 'HL', 'OIL'].includes(currentStatus)) {
// Validate dates are in correct format (YYYY-MM-DD from input type=date)
const startDate = new Date(d1);
const endDate = new Date(d2);
if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
return showToast(`Please enter valid dates for ${currentStatus}`, true);
}
if (endDate < startDate) {
return showToast("End date cannot be before start date", true);
}
// Format dates for details: DDMMYY
const startFormatted = formatDateForDetails(startDate);
const endFormatted = formatDateForDetails(endDate);
const detailsForStatus = `${startFormatted} - ${endFormatted}`;
logAttendance({
status: currentStatus,
details: detailsForStatus, // Use the formatted date range
info: "N/A"
});
} else if (currentStatus === 'Late') { // Handle Late formatting
// Format Late details as "Reason, ETA"
const lateDetails = `${d1}, ${d2}`;
logAttendance({
status: currentStatus,
details: lateDetails, // Use the formatted Late details
info: "N/A"
});
} else if (currentStatus === 'RSO') {
// Format RSO details as "Symptoms, Location"
const rsoDetails = `${d1}, ${d2}`;
logAttendance({
status: currentStatus,
details: rsoDetails, // Use the formatted RSO details
info: "N/A"
});
} else {
logAttendance({
status: currentStatus,
details: d1,
info: d2
});
}
cancelForm();
}
// Helper function to format date as DDMMYY
function formatDateForDetails(date) {
const day = String(date.getDate()).padStart(2, '0');
const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
const year = String(date.getFullYear());
// Extract last two digits of the year
const shortYear = year.substring(2);
return `${day}${month}${shortYear}`;
}
function logAttendance(data) {
const now = new Date();
const day = String(now.getDate()).padStart(2, '0');
const month = String(now.getMonth() + 1).padStart(2, '0');
const year = now.getFullYear();
const todayStr = `${day}/${month}/${year}`;
const timeStr = `${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
// Prepare date range for statuses that require it
let startDateISO = null;
let endDateISO = null;
if (['MC', 'HL', 'OIL'].includes(data.status)) {
// Parse the formatted date range string back to ISO for storage
const dateParts = data.details.split(' - ');
if (dateParts.length === 2) {
// Assuming format DDMMYY
const startPart = dateParts[0];
const endPart = dateParts[1];
const startDay = startPart.substring(0, 2);
const startMonth = startPart.substring(2, 4);
const startYear = '20' + startPart.substring(4); // Assumes 20xx century
const endDay = endPart.substring(0, 2);
const endMonth = endPart.substring(2, 4);
const endYear = '20' + endPart.substring(4);
startDateISO = new Date(Date.UTC(parseInt(startYear), parseInt(startMonth) - 1, parseInt(startDay))).toISOString();
endDateISO = new Date(Date.UTC(parseInt(endYear), parseInt(endMonth) - 1, parseInt(endDay))).toISOString();
}
}
db.collection("attendance_logs").add({
uid: currentUser.uid,
name: currentUser.name,
email: currentUser.email,
status: data.status,
details: data.details, // This will be the DDMMYY-DDMMYY string for MC/HL/OIL, "Reason, ETA" for Late, Symptoms, Location for RSO, or description for others
info: data.info,
date: todayStr, // Date of submission
time: timeStr, // Time of submission
startDate: startDateISO, // Store the start date of the range (if applicable)
endDate: endDateISO,     // Store the end date of the range (if applicable)
timestamp: firebase.firestore.FieldValue.serverTimestamp()
}).then(() => {
showToast("‚úÖ Submitted!");
// Force refresh of parade state after submission
if (document.getElementById('paradeTab').style.display === 'block') {
generateParadeState();
}
// Force refresh of missing list after submission
if (document.getElementById('missingTab').style.display === 'block') {
generateMissingList();
}
}).catch(err => {
console.error("Submission error:", err);
showToast("Submission failed: " + err.message, true);
});
}
// --- Parade State ---
function generateParadeState() {
const output = document.getElementById('paradeOutput');
const btnText = document.getElementById('paradeBtnText');
// Show loading state
output.textContent = "Loading...";
btnText.innerHTML = '<span class="loading-spinner"></span> Generating...';
const now = new Date();
const todayStr = `${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()}`;
const timeStr = `${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
// Step 1: Get course name
db.collection("settings").doc("course").get()
.then(courseDoc => {
const course = courseDoc.exists
? courseDoc.data().name || "56th Mechanical Course"
: "56th Mechanical Course";
// Step 2: Get ALL registered users (for Total Strength)
return db.collection("users").get()
.then(userSnap => {
const totalStrength = userSnap.size;
// Step 3: Get TODAY'S attendance logs (considering date ranges)
return db.collection("attendance_logs")
.orderBy("timestamp", "desc") // Order by timestamp descending to get latest first
.get()
.then(logSnap => {
// Group logs by UID and take the first one (latest due to order)
const latestLogsByUid = {};
logSnap.forEach(doc => {
const data = doc.data();
const uid = data.uid;
// Only consider logs relevant to TODAY'S parade state
// Check if the log's submission date is today OR if it has a date range that includes today
const submissionDateMatches = data.date === todayStr;
const dateRangeIncludesToday = data.startDate && data.endDate;
if (submissionDateMatches || dateRangeIncludesToday) {
if (!latestLogsByUid[uid]) {
// If this is the first log seen for this UID, store it
latestLogsByUid[uid] = data;
} // Otherwise, skip (as logs are ordered desc, first seen is latest)
}
});
// Convert object back to array
const logs = Object.values(latestLogsByUid);
// Step 4: Count statuses based on the latest log for each user on/for today
const counts = {
MA: 0, RSI: 0, RSO: 0, 'MC(Ag-)': 0, 'MC(Ag+)': 0,
HL: 0, OIL: 0, LEAVE: 0, OTH: 0, LATE: 0
};
const details = {
RSI: [], RSO: [], 'MC(Ag-)': [], LEAVE: [], LATE: [], HL: [], OIL: [], OTH: []
};
let presentCount = 0; // Count of Present separately
logs.forEach(log => {
// Check if the log's date range includes today (or if it's a same-day submission)
const isSameDaySubmission = log.date === todayStr;
const isInRange = log.startDate && log.endDate;
const isActiveToday = isSameDaySubmission || (
new Date(log.startDate).getTime() <= now.getTime() &&
new Date(log.endDate).getTime() >= now.getTime()
);
if (!isActiveToday) {
// If the latest log is not active today, it doesn't contribute to today's parade state
return;
}
if (log.status === 'Present') {
presentCount++; // Increment Present Strength
} else if (log.status === 'RSI') {
counts.RSI++;
details.RSI.push(`${log.name} (${log.details})`);
} else if (log.status === 'RSO') { // Updated RSO display format
counts.RSO++;
details.RSO.push(`${log.name} (${log.details})`); // Details already formatted as "Symptoms, Location"
} else if (log.status === 'MC') {
counts['MC(Ag-)']++;
details['MC(Ag-)'].push(`${log.name} (${log.details})`);
} else if (log.status === 'Leave') {
counts.LEAVE++;
details.LEAVE.push(`${log.name} (${log.details})`);
} else if (log.status === 'Late') { // Updated Late display format
counts.LATE++;
details.LATE.push(`${log.name} (${log.details})`); // Details already formatted as "Reason, ETA"
} else if (log.status === 'HL') { // Added HL
counts.HL++;
details.HL.push(`${log.name} (${log.details})`);
} else if (log.status === 'OIL') { // Added OIL
counts.OIL++;
details.OIL.push(`${log.name} (${log.details})`);
} else if (log.status === 'OTH') { // Added OTH
counts.OTH++;
details.OTH.push(`${log.name} (${log.details})`);
}
// MA is manual (from ref code), so it's not incremented here by user submission
});
// Step 5: Generate parade state text
let text = `Parade state at ${timeStr} (${todayStr})
Course: ${course}
Total Strength: ${totalStrength}
MA: ${counts.MA}
RSI: ${counts.RSI}`;
details.RSI.forEach(d => text += `
${d}`);
text += `
RSO: ${counts.RSO}`;
details.RSO.forEach(d => text += `
${d}`); // This now shows "Name (Symptoms, Location)"
text += `
MC(Ag-): ${counts['MC(Ag-)']}`;
details['MC(Ag-)'].forEach(d => text += `
${d}`);
text += `
MC(Ag+): ${counts['MC(Ag+)']}`;
text += `
HL: ${counts.HL}`; // Added HL
details.HL.forEach(d => text += `
${d}`); // Added HL details
text += `
OIL: ${counts.OIL}`; // Added OIL
details.OIL.forEach(d => text += `
${d}`); // Added OIL details
text += `
LEAVE: ${counts.LEAVE}`;
details.LEAVE.forEach(d => text += `
${d}`);
text += `
OTH: ${counts.OTH}`; // Added OTH
details.OTH.forEach(d => text += `
${d}`); // Added OTH details
text += `
LATE: ${counts.LATE}`;
details.LATE.forEach(d => text += `
${d}`); // This now shows "Name (Reason, ETA)"
text += `
Present Strength: ${presentCount}`;
output.textContent = text;
btnText.textContent = "üîÑ Generate Parade State";
});
});
})
.catch(err => {
console.error("Error generating parade state:", err);
output.textContent = "Error loading parade state.";
btnText.textContent = "üîÑ Generate Parade State";
});
}
// --- Missing Attendance ---
function generateMissingList() {
const output = document.getElementById('missingOutput');
const btnText = document.getElementById('missingBtnText');
// Show loading state
output.textContent = "Loading...";
btnText.innerHTML = '<span class="loading-spinner"></span> Generating...';
const today = new Date();
const todayStr = `${today.getDate().toString().padStart(2,'0')}/${(today.getMonth()+1).toString().padStart(2,'0')}/${today.getFullYear()}`;
db.collection("users").get().then(userSnap => {
const allUsers = userSnap.docs.map(d => ({ uid: d.id, name: d.data().name }));
return db.collection("attendance_logs")
.orderBy("timestamp", "desc") // Order by timestamp descending
.get()
.then(logSnap => {
// Group logs by UID and take the first one (latest due to order)
const latestLogsByUid = {};
logSnap.forEach(doc => {
const data = doc.data();
const uid = data.uid;
if (!latestLogsByUid[uid]) {
latestLogsByUid[uid] = data;
}
});
const presentUids = new Set();
// Iterate through latest logs to determine who is present today
Object.values(latestLogsByUid).forEach(log => {
// Check if the log's date range includes today (or if it's a same-day submission)
const isSameDaySubmission = log.date === todayStr;
const isInRange = log.startDate && log.endDate;
const isActiveToday = isSameDaySubmission || (
new Date(log.startDate).getTime() <= today.getTime() &&
new Date(log.endDate).getTime() >= today.getTime()
);
if (isActiveToday) {
presentUids.add(log.uid); // Add UID if active today
}
});
const missing = allUsers.filter(u => !presentUids.has(u.uid)).map(u => u.name);
output.textContent = missing.length > 0
? missing.join('
')
: "All personnel have submitted.";
btnText.textContent = "üîÑ Generate Missing List";
});
}).catch(err => {
console.error("Error loading missing list:", err);
output.textContent = "Error loading missing list.";
btnText.textContent = "üîÑ Generate Missing List";
});
}
// --- Clipboard Functions ---
function copyParadeState() {
navigator.clipboard.writeText(document.getElementById('paradeOutput').textContent)
.then(() => showToast("üìã Copied!"));
}
function copyMissingList() {
navigator.clipboard.writeText(document.getElementById('missingOutput').textContent)
.then(() => showToast("üìã Copied!"));
}
// Auto-login handling - persists across page refreshes
auth.onAuthStateChanged(user => {
if (user) {
// User is logged in, try to load their profile
db.collection("users").doc(user.uid).get().then(doc => {
if (doc.exists) {
const data = doc.data();
currentUser = {
uid: user.uid,
email: user.email,
name: data.name,
role: "trainee"
};
initApp();
} else {
// New user who just registered
currentUser = { uid: user.uid, email: user.email };
showScreen('registerScreen');
}
}).catch(err => {
console.error("Error loading user ", err);
showToast("Failed to load user data", true);
});
} else {
// User is not logged in
showScreen('loginScreen');
}
});
</script>
</body>
</html>
